workflow:
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH =~ /^(dev|stg|main)$/

stages:
  - lint
  - test
  - build
  - deploy-test

variables:
  ATD_IMAGE: "${CI_REGISTRY_IMAGE}/atd"
  VPN_IMAGE: "${CI_REGISTRY_IMAGE}/vpn"

# Lint jobs - run on MR only
shellcheck:
  stage: lint
  tags:
    - k8s
    - docker
  image: koalaman/shellcheck-alpine:latest
  script:
    - shellcheck scripts/*.sh
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

hadolint-atd:
  stage: lint
  tags:
    - k8s
    - docker
  image: hadolint/hadolint:latest-alpine
  script:
    - hadolint dockerfile.atd
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

hadolint-vpn:
  stage: lint
  tags:
    - k8s
    - docker
  image: hadolint/hadolint:latest-alpine
  script:
    - hadolint dockerfile.vpn
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

# Unit tests - run on MR only
unit-tests:
  stage: test
  tags:
    - k8s
    - docker
  image: ubuntu:22.04
  before_script:
    - apt-get update -qq && apt-get install -qq -y bats jq >/dev/null
  script:
    - bats tests/unit/
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

# Build jobs - run on push to dev/stg/main
build-atd:
  stage: build
  tags:
    - k8s
    - docker
  image:
    name: gcr.io/kaniko-project/executor:debug
    entrypoint: [""]
  before_script:
    - mkdir -p /kaniko/.docker
    - echo "{\"auths\":{\"${CI_REGISTRY}\":{\"auth\":\"$(printf "%s:%s" "${CI_REGISTRY_USER}" "${CI_REGISTRY_PASSWORD}" | base64 | tr -d '\n')\"}}}" > /kaniko/.docker/config.json
  script:
    - /kaniko/executor
      --context "${CI_PROJECT_DIR}"
      --dockerfile "${CI_PROJECT_DIR}/dockerfile.atd"
      --destination "${ATD_IMAGE}:${CI_COMMIT_REF_NAME}"
      --destination "${ATD_IMAGE}:sha-${CI_COMMIT_SHORT_SHA}"
  rules:
    - if: $CI_COMMIT_BRANCH =~ /^(dev|stg|main)$/

build-vpn:
  stage: build
  tags:
    - k8s
    - docker
  image:
    name: gcr.io/kaniko-project/executor:debug
    entrypoint: [""]
  before_script:
    - mkdir -p /kaniko/.docker
    - echo "{\"auths\":{\"${CI_REGISTRY}\":{\"auth\":\"$(printf "%s:%s" "${CI_REGISTRY_USER}" "${CI_REGISTRY_PASSWORD}" | base64 | tr -d '\n')\"}}}" > /kaniko/.docker/config.json
  script:
    - /kaniko/executor
      --context "${CI_PROJECT_DIR}"
      --dockerfile "${CI_PROJECT_DIR}/dockerfile.vpn"
      --destination "${VPN_IMAGE}:${CI_COMMIT_REF_NAME}"
      --destination "${VPN_IMAGE}:sha-${CI_COMMIT_SHORT_SHA}"
  rules:
    - if: $CI_COMMIT_BRANCH =~ /^(dev|stg|main)$/

# Deploy-test template
.deploy-test:
  stage: deploy-test
  tags:
    - k8s
    - docker
  image: alpine/k8s:1.28.3
  needs:
    - build-atd
    - build-vpn
  before_script:
    - apk add --no-cache bash curl
  script:
    - echo "Restarting deployment to pull new image..."
    - kubectl rollout restart deployment/${DEPLOYMENT} -n ${NAMESPACE}

    - echo "Waiting for rollout to complete..."
    - kubectl rollout status deployment/${DEPLOYMENT} -n ${NAMESPACE} --timeout=180s

    - echo "Verifying ATD pod is running..."
    - |
      for i in $(seq 1 30); do
        ATD_POD=$(kubectl get pods -n ${NAMESPACE} -l app=atd --no-headers | grep Running | head -1 | awk '{print $1}')
        if [ -n "$ATD_POD" ]; then
          echo "ATD pod is running: $ATD_POD"
          break
        fi
        echo "Waiting for ATD pod (attempt $i)..."
        sleep 5
      done
      if [ -z "$ATD_POD" ]; then
        echo "ATD pod not running after 30 attempts"
        exit 1
      fi

    - echo "Checking Transmission daemon is responsive..."
    - |
      for i in $(seq 1 10); do
        if kubectl exec -n ${NAMESPACE} $ATD_POD -c automatic-transmission-daemon -- transmission-remote localhost:9091 -si > /dev/null 2>&1; then
          echo "Transmission daemon is responsive!"
          break
        fi
        echo "Transmission check attempt $i, waiting..."
        sleep 5
      done
      # Final check with output
      kubectl exec -n ${NAMESPACE} $ATD_POD -c automatic-transmission-daemon -- transmission-remote localhost:9091 -si || exit 1

    - echo "Verifying VPN sidecar connection..."
    - |
      VPN_IP=$(kubectl exec -n ${NAMESPACE} $ATD_POD -c vpn-sidecar -- curl -sf ifconfig.me 2>/dev/null || echo "unavailable")
      if [ "$VPN_IP" = "unavailable" ]; then
        echo "Warning: Could not verify VPN connection (non-blocking)"
      else
        echo "VPN connected, external IP: $VPN_IP"
      fi

    - echo "All checks passed!"

# Deploy-test for dev
deploy-test-dev:
  extends: .deploy-test
  resource_group: atd-dev
  variables:
    DEPLOYMENT: "atd-dev"
    NAMESPACE: "media-dev"
  rules:
    - if: $CI_COMMIT_BRANCH == "dev"

# Deploy-test for stg
deploy-test-stg:
  extends: .deploy-test
  resource_group: atd-stg
  variables:
    DEPLOYMENT: "atd-stg"
    NAMESPACE: "media-stg"
  rules:
    - if: $CI_COMMIT_BRANCH == "stg"

# Deploy-test for prod
deploy-test-prod:
  extends: .deploy-test
  resource_group: atd-prod
  variables:
    DEPLOYMENT: "atd-prod"
    NAMESPACE: "media-prod"
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
