services:
  gluetun:
    image: qmcgaw/gluetun:latest
    container_name: gluetun
    restart: unless-stopped
    cap_add:
      - NET_ADMIN
    devices:
      - /dev/net/tun:/dev/net/tun
    ports:
      - "9091:9091"       # Transmission web UI
      - "51413:51413"     # Transmission peer port
      - "51413:51413/udp"
    environment:
      # gluetun config
      - VPN_SERVICE_PROVIDER=custom
      - VPN_TYPE=wireguard
      # wireguard interface (mapped from .env)
      - WIREGUARD_PRIVATE_KEY=${WIREGUARD_PRIVATE_KEY}
      - WIREGUARD_ADDRESSES=${WIREGUARD_ADDRESS_IPV4}
      - WIREGUARD_MTU=${WIREGUARD_MTU}
      - WIREGUARD_IMPLEMENTATION=userspace
      # wireguard peer (mapped from .env)
      - WIREGUARD_PUBLIC_KEY=${WIREGUARD_PUBLIC_KEY}
      - WIREGUARD_ENDPOINT_IP=${WIREGUARD_ENDPOINT_IP}
      - WIREGUARD_ENDPOINT_PORT=${WIREGUARD_ENDPOINT_PORT}
      # dns config - use VPN's DNS directly, no DoT
      - DNS_ADDRESS=${WIREGUARD_DNS}
      - DOT=off
    volumes:
      - ./gluetun:/gluetun
    healthcheck:
      test: ["CMD-SHELL", "wget -q -O- https://ipinfo.io/ip || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  transmission:
    image: lscr.io/linuxserver/transmission:latest
    container_name: transmission
    restart: unless-stopped
    network_mode: "service:gluetun"
    environment:
      - PUID=1005
      - PGID=1001
      - TZ=America/Los_Angeles
    volumes:
      - ./config:/config
      - ./media-cache/complete:/downloads/complete
      - ./media-cache/incomplete:/downloads/incomplete
    depends_on:
      gluetun:
        condition: service_healthy
